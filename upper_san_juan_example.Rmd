---
title: "Upper San Juan USGS + SNOTEL Data Pull"
author: "Lydia Bleifuss"
date: "4/27/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
```

```{r Packages, echo = FALSE}
#USGS
library(dataRetrieval)

#SNOTEL
#library()

#Other 
library(tidyverse)
library(ggplot2)
library(leaflet)
library(dplyr)
library(maps)
library(lubridate)
library(janitor)
library(tsibble)
library(snakecase)
library(stringr)
library(paletteer)
library(feasts)
```


#####**HUC USGS locator map:** https://water.usgs.gov/wsc/map_index.html

#####**HUC 8 Data Basin locator map:** https://databasin.org/maps/df7fa3b1a0cc4ee997a677a29b6e9523/active

###**Functions/Data Types/Information Available**
NWIS
- readNWISdv | NWIS daily data
- readNWISqw | 	NWIS water quality data
- readNWISuv | NWIS instantaneous value data
- readNWISrating | NWIS rating table for active streamgage
- readNWISmeas | 	NWIS surface-water measurements
- readNWISpeak | NWIS peak flow data
- readNWISgwl | 	NWIS groundwater level measurements
- readNWISuse | NWIS water use
- readNWISstat | NWIS statistical service
- readNWISpCode | NWIS parameter code information
- readNWISsite | NWIS site information
- whatNWISsites | NWIS site search using user-specified queries
- whatNWISdata | NWIS data availability, including period of record and count
- readNWISdata | NWIS data using user-specified queries

```{r AR Graph Theme}

theme_ar = function(base_size = 12, base_family = "Avenir") {
  theme_grey(base_size = base_size, base_family = base_family) %+replace%
    theme(
      
      # Specify axis options
      axis.line = element_line(),  
      axis.text.x = element_text(size = base_size*0.8, color = "black", lineheight = 0, angle = 45),  
      axis.text.y = element_text(size = base_size*0.8, color = "black", lineheight = 0),  
      #axis.ticks = element_line(color = "black", size  =  0.2),  
      axis.title.x = element_text(size = base_size, color = "black", margin = margin(0, 10, 0, 0)),  
      axis.title.y = element_text(size = base_size, face = "bold", color = "black", angle = 90, margin = margin(0, 10, 0, 0)),  
      #axis.ticks.length = unit(0.3, "lines"), 
      
      # Specify legend options
      legend.background = element_rect(color = "NA", fill = NA),  
      legend.key = element_rect(color = NA,  fill = NA),  
      #legend.key.size = unit(1.2, "lines"),  
      legend.key.height = NULL,  
      legend.key.width = NULL,      
      legend.text = element_text(size = base_size*0.8, color = "black"),  
      legend.title = element_text(size = base_size*0.8, face = "bold", hjust = 0, color = "black"),  
      #legend.position = "bottom",  
      legend.text.align = NULL,  
      legend.title.align = NULL,  
      #legend.direction = "horizontal",  
      legend.box = NULL, 
      
      # Specify panel options
      panel.background = element_rect(fill = NA, color  =  NA),  
      panel.border = element_rect(fill = NA, color = NA),  
      panel.grid.major = element_line(color = NA),  
      panel.grid.minor = element_line(color = NA),  
      panel.margin = unit(0, "lines"),   
      
      # Specify facetting options
      strip.background = element_rect(fill = "grey30", color = "grey10"),  
      strip.text.x = element_text(size = base_size*0.8, color = "black"),  
      strip.text.y = element_text(size = base_size*0.8, color = "black",angle = -90),  
      
      # Specify plot options
      plot.background = element_rect(color = NA, fill = NA),  
      plot.title = element_text(size = base_size*1.2, color = "black", face = "bold", margin=margin(0,0,5,0)),  
      plot.subtitle = element_text(size = base_size*0.9, color = "black"),
      plot.margin = unit(rep(1, 4), "lines")
    )
}


#View(palettes_c_names)
#ggsave("your_title.pdf", device=cairo_pdf, width = 6, height = 6)
```



```{r Upper San Juan USGS AVAILABLE, echo = FALSE }

#Get to know what data is available in the watershed

sj_available_data <- whatNWISdata(huc = '14080101') #HUC 8 for Upper San Juan 

comment(sj_available_data) 
#defines all column heading included in teh dataset 

#Now if we want to specify search, specify by param in the watershed 

#Search params: https://nwis.waterdata.usgs.gov/usa/nwis/pmcodes

#Useful params: 
# Discharge, mean daily (cfs) | 00060
# Discharge, instantaneous (cfs) | 00061
# Precipitation total (in) | 00045

#Exploring Discharge Specifically: 

#dis_codes <- parameterCdFile[grep("discharge", parameterCdFile$parameter_nm, ignore.case = TRUE),] 
#pulling all params that have to do with discharge

nrow(dis_codes) #There are 24 different params for discharge
unique(dis_codes$parameter_units) #what are the units? 

```


```{r Upper San Juan USGS PULL ONE GUAGE, echo = FALSE }
#SAN JUAN RIVER AT PAGOSA SPRINGS, CO

sjp_site_no <- "09342500"
sjp_pcode <- "00060" #discharge
sjp_start_date <- "2009-10-01"
sjp_end_date <- "2019-09-30"

sj_pagosa <- readNWISuv(siteNumbers = sjp_site_no, #uv is calling for instantaneous data
                     parameterCd = sjp_pcode,
                     startDate = sjp_start_date,
                     endDate = sjp_end_date)

#IMPORTANT: 
#Column names for discharge and discharge code are read in as "X_00060_00011"  and  "X_00060_00011_cd" 
names(sj_pagosa)

#To clean up these columns (should alwasy do this for consistency)
sj_pagosa <- renameNWISColumns(sj_pagosa)
names(sj_pagosa)
#Now these columns are "Flow_Inst" and "Flow_Inst_cd" 


#There are also several attributes attached to each dataframe you pull in, to access these: 
names(attributes(sj_pagosa))

#To access these attributes, such as the url to the well, see example below: 
url <- attr(sj_pagosa, "url")

#Site info
sjp_site <- attr(sj_pagosa, "siteInfo") %>% 
  mutate(station_nm = str_to_title(station_nm))
  
#Parameter info
sjp_parameter <- attr(sj_pagosa, "variableInfo")

#Join site info with discharge data to create full tidy df

sjp_dis_join <- full_join(sjp_site, sj_pagosa, by = "site_no") %>% 
  select(station_nm, 
         site_no, 
         dec_lat_va, 
         dec_lon_va, 
         hucCd, 
         dateTime, 
         Flow_Inst, 
         Flow_Inst_cd) %>% 
  rename(station_nm = station_nm, 
         site_no = site_no, 
         latitude = dec_lat_va, 
         longitude = dec_lon_va, 
         huc = hucCd, 
         dateTime = dateTime, 
         Flow_Inst = Flow_Inst, 
        Flow_Inst_cd = Flow_Inst_cd) %>% 
  mutate(date = as.Date.POSIXct(dateTime)) %>% #need to seperate date from time, so can find average daily cfs, and plot that
  mutate(year_month = yearmonth(date)) %>%  
  mutate(month = month(date)) %>% 
  group_by(year_month) %>% 
  mutate(average_month_dis = mean(Flow_Inst)) %>% 
  mutate(average_month_dis = round(average_month_dis, 0)) %>% 
  distinct(year_month, .keep_all = TRUE) %>% 
  select(-dateTime, -Flow_Inst)

head(sjp_dis_join)

```

```{r Upper San Juan USGS GRAPH, echo = FALSE}

#Basic graph to get a sense for things: 

sjp_dis_graph <- ggplot(data = sjp_dis_join,
                        aes(date, 
                            average_month_dis)) +
  geom_line() +
  theme_ar() +
  xlab("") +
  ylab(sjp_parameter$variableDescription) +
  ggtitle(sjp_site$station_nm) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_date(date_breaks = "1 year",
               date_labels = "%Y",
               expand = expansion()
               ) +
  labs(caption = "\nAverage monthly streamflow in the Upper San Juan River near Pagosa Springs, CO from 2009 - 2019.")
  
  
sjp_dis_graph

```

```{r Upper San Juan USGS SEASON GRAPH, echo = FALSE}

# Coerce to a tsibble:
sjp_auto <- as_tsibble(sjp_dis_join, index = year_month) %>% 
  tsibble::fill_gaps()

sjp_seasonal <- sjp_auto %>% 
  feasts::gg_season(average_month_dis) +
  scale_y_continuous(expand = c(0,0)) +
  scale_x_date(date_breaks = "1 month",
               date_labels = "%b", #codes from abrivs https://rdrr.io/r/base/strptime.html
               expand = expansion()
               ) +
  xlab("\nMonth") +
  ylab("Average Monthly Streamflow (cfs)") +
  labs(title = "Seasonal Streamflow at Upper San Juan",
       subtitle = "USGS Guage at Pagosa Springs, CO (2009 - 2019)\n") +
  theme(plot.title = element_text(vjust = 0.5)) +
  theme_ar()

sjp_seasonal
```


```{r Upper San Juan USGS MONTH GRAPH, echo = FALSE}

sjp_subseries <- sjp_auto %>% #Great graphical exploration, provides mean for each month across all months. 
  feasts::gg_subseries(average_month_dis) +
  xlab("\nMonth") +
  ylab("Average Streamflow (cfs)\n") +
  ggtitle("Average Streamflow Across all Years (2009 - 2019)\n") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.ticks.x = element_blank(),
        panel.grid = element_blank())+
  scale_x_date(date_breaks = "120 months",
               date_labels = "%M")

sjp_subseries
```


```{r Upper San Juan USGS PULL ALL GUAGE, echo = FALSE }
sj_dis_sites <- 
```

```{r Upper San Juan USGS GRAPH, echo = FALSE }

```

```{r Upper San Juan USGS MAP, echo = FALSE }

```

```{r Upper San Juan SNOTEL PULL, echo = FALSE }

```

```{r Upper San Juan SNOTEL GRAPH, echo = FALSE }

```

```{r Upper San Juan SNOTEL MAP, echo = FALSE }

```

```{r Upper San Juan STATS - DECOMP, echo = FALSE }
#average snowpack year, deviation above and below? 

#USGS Stats Code: https://help.waterdata.usgs.gov/code/stat_cd_nm_query?stat_nm_cd=%25&fmt=html

```

```{r Upper San Juan ALL MAP, echo = FALSE }

```

```{r Upper San Juan CSV Export}

```

