---
title: "dataRetrieval_samples"
author: "Lydia Bleifuss"
date: "4/29/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
###**Information:** 

Complete documentation: 
https://cran.r-project.org/web/packages/dataRetrieval/dataRetrieval.pdf

Full run through (March 2020): https://cran.r-project.org/web/packages/dataRetrieval/vignettes/dataRetrieval.html

Getting started: 
https://cran.r-project.org/web/packages/dataRetrieval/vignettes/dataRetrieval.html#getting-started-in-r

Type vignette("dataRetrieval") into RStudio Console to pull up the above links w/in RStudio 

###**General Purpose:** 

"The dataRetrieval package was created to simplify the process of loading hydrologic data into the R environment. It is designed to retrieve the major data types of U.S. Geological Survey (USGS) hydrologic data that are available on the Web, as well as data from the Water Quality Portal (WQP), which currently houses water quality data from the Environmental Protection Agency (EPA), U.S. Department of Agriculture (USDA), and USGS. Direct USGS data is obtained from a service called the National Water Information System (NWIS)."

```{r}
library(dataRetrieval)

#Other 

library(tidyverse)
library(ggplot2)
library(leaflet)
library(dplyr)

```

###**TIPS:** 

Type ?readNWISpCode in the Console and USGS Parameteer Data REtrieval informaiton will populate in the Help window. 

Site Ids: "Often (but not always), USGS ID’s are 8 digits for surface-water sites and 15 digits for groundwater sites. The first step to finding data is discovering this siteNumber. There are many ways to do this, one is the National Water Information System: Mapper"

https://maps.waterdata.usgs.gov/mapper/index.html

RENAME columns with specific renameNWISColumns funtion after pulling in data and creating a dataframe: 

df <- renameNWISColumns(df)

You can add a WATER YEAR COLUMN:
addWaterYear(rawData)


###**Functions/Data Types/Information Available**
NWIS
- readNWISdv | NWIS daily data
- readNWISqw | 	NWIS water quality data
- readNWISuv | NWIS instantaneous value data
- readNWISrating | NWIS rating table for active streamgage
- readNWISmeas | 	NWIS surface-water measurements
- readNWISpeak | NWIS peak flow data
- readNWISgwl | 	NWIS groundwater level measurements
- readNWISuse | NWIS water use
- readNWISstat | NWIS statistical service
- readNWISpCode | NWIS parameter code information
- readNWISsite | NWIS site information
- whatNWISsites | NWIS site search using user-specified queries
- whatNWISdata | NWIS data availability, including period of record and count
- readNWISdata | NWIS data using user-specified queries

WQP
- readWQPdata | WQP data using user-specified queries
- readWQPqw | WQP data
- whatWQPsites | WQP site search using user-specified queries


###**Basic Steps**
1. Find Site ID(s) you are interested in (siteNumber)
2. Determine which parameter code (pCode) is of interest

###**Example Code**

####Pulling site info:
Site into is obtained from the USGS REST system: 
https://waterservices.usgs.gov/rest/Site-Test-Tool.html

```{r}
siteNumbers <- c("01491000","01645000") #defining sites of interest

siteINFO <- readNWISsite(siteNumbers) #pulling site into

comment(siteINFO) #explains column names from the siteINFO pulled above

dailyDataAvailable <- whatNWISdata(siteNumbers = siteNumbers, 
                                   service="dv") #helpful if you are interesting in a certain subset of data contained at the site of interest, this example limits to daily data
```

whatNWISdata: "It is possible to limit the retrieval information to a subset of services. The possible choices for services are: “dv” (daily values), “uv”, or “iv” (unit values), “qw” (water-quality), “sv” (sites visits), “pk” (peak measurements), “gw” (groundwater levels), “ad” (sites included in USGS Annual Water Data Reports External Link), “aw” (sites monitored by the USGS Active Groundwater Level Network External Link), and “id” (historical instantaneous values)"

####Pulling parameter info:
Search params: https://nwis.waterdata.usgs.gov/usa/nwis/pmcodes

Physical params: https://nwis.waterdata.usgs.gov/usa/nwis/pmcodes?radio_pm_search=param_group&pm_group=Physical&pm_search=&casrn_search=&srsname_search=&format=html_table&show=parameter_group_nm&show=parameter_nm&show=casrn&show=srsname&show=parameter_units

Useful params: 

- Depth to water level (ft bls) | 72019
- Water level, depth below land surface, (meters) | 99019
- Depth to water level, below land surface datum (LSD) (meters) | 30210


- Discharge, mean daily (cfs) | 00060
- Discharge, instantaneous (cfs) | 00061
- Precipitation total (in) | 00045

Stats codes: 
https://help.waterdata.usgs.gov/code/stat_cd_nm_query?stat_nm_cd=%25&fmt=html

Useful stats: 
- Max | 00001
- Min | 00002
- Mean | 00003
- Median | 00008

```{r}
# Using defaults:
parameterCd <- "00618" 
parameterINFO <- readNWISpCode(parameterCd)
```


####Pulling data from a single site (example 1):

```{r}
# Choptank River near Greensboro, MD
siteNumber <- "01491000" 
ChoptankInfo <- readNWISsite(siteNumber) #pulls in all site info including spatial (lat,long)
parameterCd <- "00060"

#Raw daily data:
rawDailyData <- readNWISdv(siteNumber,
                           parameterCd,
                      "1980-01-01",
                      "2010-01-01")

# Sample data Nitrate:
parameterCd <- "00618"

qwData <- readNWISqw(siteNumber,
                     parameterCd,
                      "1980-01-01",
                     "2010-01-01")

pCode <- readNWISpCode(parameterCd) #pulls in p-code informaiton
```

####Pulling data from a single site (example 2):

```{r}

# Choptank River near Greensboro, MD:
siteNumber <- "01491000"
parameterCd <- "00060"  # discharge
startDate <- "2009-10-01"  #can define start and end dates to use in different calls 
endDate <- "2012-09-30" 

yahara_discharge <- readNWISdv(siteNumber, #asking for daily data at this site
                    parameterCd, #asking for discharge 
                    startDate, #asking to start here
                    endDate) #asking to end here 

```

####Graphing data from a single site (example 3a):

```{r}
#Windsor River Wisconsin! 

siteNo <- "05427718"
pCode <- "00060" #discharge
start.date <- "2014-10-01"
end.date <- "2015-09-30"

yahara <- readNWISuv(siteNumbers = siteNo, #uv is calling for instantaneous data
                     parameterCd = pCode,
                     startDate = start.date,
                     endDate = end.date)

#IMPORTANT: 

#Column names for discharge and discharge code are read in as "X_00060_00011"  and  "X_00060_00011_cd" 

names(yahara)

#To clean up these columns (should alwasy do this for consistency)

yahara <- renameNWISColumns(yahara)
names(yahara)

#Now these columns are "Flow_Inst" and "Flow_Inst_cd" 


#There are also several attributes attached to each dataframe you pull in, to access these: 

names(attributes(yahara))

#To access these attributes, such as the url to the well, see example below: 

url <- attr(yahara, "url")
```

####Graphing data from a single site with Metadata attached! (example 3b):

```{r}

parameterInfo <- attr(yahara, "variableInfo")
siteInfo <- attr(yahara, "siteInfo")

yahara_graph <- ggplot(yahara, 
                       aes(dateTime, Flow_Inst)) +
  geom_line()

yahara_graph <- yahara_graph +
  xlab("") +
  ylab(parameterInfo$parameter_desc) + #look at why y axis is not working
  ggtitle(siteInfo$station_nm) 

yahara_graph
  

```
###Pulling in date by "box" or lat long coordinates:
```{r}

bBoxEx <- readNWISdata(bBox=c(-83,36.5,-81,38.5), parameterCd="00010") #temp data 

bBoxEx <- renameNWISColumns(bBoxEx)
names(bBoxEx)

```


```{r}

dtw_pCode <- c("72019") #groundwater levels, depth to water (lev_va is the column heading)
dtw_parameterINFO <- readNWISpCode(dtw_pCode)


wy_sites <- readNWISdata(stateCd="WY", 
                         service="site",
                         seriesCatalogOutput=TRUE) %>% #include this to include parm_cd
  filter(parm_cd == dtw_pCode) #%>% 
  #renameNWISColumns() %>% 
 # select(agency_cd, )
  

wy_dtw <- readNWISdata(stateCd="WY", service="gwlevels") %>% 
  renameNWISColumns() %>% 
  select(agency_cd, site_no, lev_dt, lev_va)


wy_all_new <- merge(wy_dtw, wy_sites, by = "site_no")

#length(unique(wy_dtw$site_no))
```


####Pulling groundwater levels:
https://cran.r-project.org/web/packages/dataRetrieval/vignettes/dataRetrieval.html#groundwater-level-data

Use function readNWISgwl or readNWISdata with "gwlevels" service to pull full state

**Note cannot use readNWISsites w/ state code, need to specify sites wiht that, instead use readNWISdata and specify that the serviec is "site"

```{r}
#Option, by site:  
siteNumber <- "311959110372001"
groundWater <- readNWISgwl(siteNumber)

#Option 2, by state: 
azGWL <- readNWISdata(stateCd="AZ", service="gwlevels") #read in gwlevels for AZ (cannot read in entire state using readNWISgwl)

azGWL <- renameNWISColumns(azGWL)
names(azGWL)


azGWsites <- azGWL %>% 
  drop_na(lev_va) %>% 
  distinct(site_no, .keep_all = TRUE) %>% 
  readNWISsite(siteNumbers = azGWL$site_no)

az_all <- inner_join(azGWL, azGWsites, by = "site_no")


```
Error: 
azGWsites <- readNWISsite(siteNumbers = azGWL$site_no) 
Request failed [400]. Retrying in 1 seconds...
Request failed [400]. Retrying in 1 seconds...
Error in getWebServiceData(obs_url, encoding = "gzip") : 
  HTTP Status 400 - Input list size exceeded [keyword=[site], max-list-size=[35000]]
  

"35,000 limit on records retrieved from NWISWeb
Currently NWISWeb has imposed an internal limit of 35,000 limit on records returned for one instance of a query.   We recently increased the limit from 20,000 to 35,000 and will continue to consider increasing the limit. In the meantime, if you are having difficulties acquiring all the data in a large request, we suggest one solution is to start at the inventory pages for the individual states and try pulling by county. For example, the inventory page for Texas is:
http://waterdata.usgs.gov/tx/nwis/inventory

where tx can be replaced by the two-letter postal code of the state of interest. By selecting a limited number of the counties, the number of records retrieved should be under the record limit.""


####Pulling groundwater levels from National Ground Water Monitoring Network specifically! Basically vetted wells: 
https://cida.usgs.gov/ngwmn/

The National Ground-Water Monitoring Network (NGWMN) started as a product of the Subcommittee  on Ground Water  of the Federal Advisory Committee on Water Information (ACWI). The  NGWMN is a compilation of selected groundwater monitoring wells from Federal, State, and  local groundwater monitoring networks across the nation.

The NGWMN Data Portal (https://cida.usgs.gov/ngwmn/index.jsp) provides access to groundwater data from multiple, dispersed  databases in a web-based mapping application. The portal contains current and historical data  including water levels, water quality, lithology, and well construction. The NGWMN is currently  in the process of adding new data providers to the Network. Agencies or organizations collecting  groundwater data can find out more about becoming a data provider for the Network (https://cida.usgs.gov/ngwmn/learnmore.jsp#getInvolved).

Funding to support data providers to the National Ground-Water Monitoring Network is  provided through  USGS Cooperative Agreements. Agencies can also find  information about the status of the  USGS cooperative agreements (https://cida.usgs.gov/ngwmn/cooperativeagreements.jsp).

2019! 
https://cida.usgs.gov/ngwmn/doc/NGWMN_FY19_ProjectSummary.pdf

```{r}
#readNGWMNlevels(siteNumbers, asDateTime = TRUE, tz = "UTC")

#"DISCLAIMER: NGWMN retrieval functions are still in flux, and no future behavior or output is guaranteed" - this is likely refering to the fact that NGWMN needs to be updated each year based on contracted state agencies 

#one site
site <- "USGS.430427089284901"
oneSite <- readNGWMNlevels(siteNumbers = site)

#multiple sites
sites <- c("USGS:272838082142201","USGS:404159100494601", "USGS:401216080362703")
multiSiteData <- readNGWMNlevels(sites)

#non-USGS site
site <- "MBMG.103306"
#data <- readNGWMNlevels(siteNumbers = site, asDateTime = FALSE)

```


###Pulling in all discharge data by state:

```{r}
dailyWV <- readNWISdata(stateCd = "West Virginia", parameterCd = "00060") #discharge, cfs, daily mean

dailyWV <- renameNWISColumns(dailyWV)
names(dailyWV)
```

###Bring in with HUC number
```{r}
# Major filter: HUC 8 for Maui, 20020000
# Service: daily value, dv
# Statistic: minimum, 00002
# Parameter code: water temperature in deg C, 00010

MauiHUC8_mindailyT <- readNWISdata(huc="20020000", service="dv", statCd="00002", parameterCd="00010")
head(MauiHUC8_mindailyT)
```


###AMAZING EXAMPLE WITH MAP!!!


###Pulling in phosphorous data in Wisconsin:
```{r}
pCode <- c("00662","00665")
phWI <- readNWISdata(stateCd="WI", service="site",
                     seriesCatalogOutput=TRUE)

phWI.1 <- filter(phWI, parm_cd %in% pCode) %>%
            filter(count_nu > 300) %>%
            mutate(period = as.Date(end_date) - as.Date(begin_date)) %>%
            filter(period > 15*365)
```


```{r}
library(leaflet)
leaflet(data=phWI.1) %>% 
  addProviderTiles("CartoDB.Positron") %>%
  addCircleMarkers(~dec_long_va,~dec_lat_va,
                   color = "red", radius=3, stroke=FALSE,
                   fillOpacity = 0.8, opacity = 0.8,
                   popup=~station_nm)
```



